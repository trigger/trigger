# v2.0.0 Release Design: Python 3 Support & Automated Release Pipeline

**Date:** 2026-02-02
**Status:** Approved
**Target Audience:** Both existing v1.6.0 users upgrading from Python 2.7 and new users

## Overview

This design establishes a comprehensive release strategy for Trigger v2.0.0 with Python 3.10-3.11 support and implements a modern CI/CD pipeline using conventional commits for automated semantic versioning and releases.

## Goals

1. Release Trigger v2.0.0 with full Python 3.10-3.11 support
2. Clearly communicate Python 2.7 end-of-support while emphasizing configuration compatibility
3. Implement automated semantic release workflow using conventional commits
4. Simplify branch strategy to single main branch with high-confidence automation
5. Establish automated PyPI publishing and GitHub releases

## Non-Goals

- Python 3.12+ support (blocked by SimpleParse compatibility)
- Maintaining Python 2.7 compatibility
- Complex multi-branch workflows (explicitly avoiding develop branch)

## Design

### 1. Branch Strategy & Workflow Architecture

**Current State:**
- `develop` branch: currently default, active Python 3 work
- `master` branch: exists, needs renaming
- `release/v2.0.0` branch: temporary preparation branch

**Target State - Single Branch Workflow:**

**`main` branch** (default, protected):
- Single source of truth for all releases
- All PRs target main directly
- CI runs full test suite + linting on every PR
- python-semantic-release runs in preview mode on PRs to show next version
- Merging to main triggers automated release workflow
- Branch protection requires: passing tests, approved reviews

**Feature/fix branches:**
- Created from main
- Use conventional commit messages (fix:, feat:, BREAKING CHANGE:)
- PR to main with automatic version preview

**Transition Plan:**
1. Rename `master` → `main` (via GitHub settings)
2. Update default branch to `main`
3. Merge `develop` into `main` to bring Python 3 work over
4. Deprecate `develop` branch (add deprecation notice, archive/delete)
5. Use `release/v2.0.0` temporarily for v2.0.0 prep, delete after release

**Rationale:** With conventional commits and comprehensive CI, a develop branch adds unnecessary overhead. Direct-to-main with automation provides high confidence while reducing complexity.

### 2. Conventional Commits & Semantic Versioning

**Commit Message Format (Angular specification):**

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types that trigger releases:**
- `fix:` → Patch release (2.0.0 → 2.0.1)
- `feat:` → Minor release (2.0.0 → 2.1.0)
- `BREAKING CHANGE:` in footer or `feat!:`/`fix!:` → Major release (2.0.0 → 3.0.0)

**Types that don't trigger releases:**
- `docs:`, `chore:`, `style:`, `refactor:`, `test:`, `ci:`

**Example Commits:**
```bash
fix(acl): handle IPv6 addresses in parser correctly

feat(netdevices): add support for Arista EOS 4.x

feat(cmds)!: remove Python 2.7 compatibility shims

BREAKING CHANGE: Python 2.7 is no longer supported. Minimum version is Python 3.10.
```

**python-semantic-release Integration:**
- Analyzes git history since last tag
- Generates changelog from commit messages
- Updates version in pyproject.toml
- Creates git tag
- Builds package with `uv build`
- Publishes to PyPI
- Creates GitHub release with auto-generated notes

### 3. GitHub Actions Workflow Design

**Three Workflows:**

#### Workflow 1: `ci.yml` - Continuous Integration

**Triggers:** Pull requests to main, pushes to main

**Jobs:**
- **Test Matrix:** Python 3.10 and 3.11 on ubuntu-latest
- **Linting:** `ruff check trigger/ tests/` (replaces flake8/black/isort)
- **Formatting:** `ruff format --check trigger/ tests/`
- **Tests:** Full test suite with pytest (`uv run --extra dev pytest -v`)
- **Build Verification:** `uv build` to verify package builds cleanly
- **Artifacts:** Store build artifacts for inspection

**Purpose:** Ensure every PR is production-ready before merge.

#### Workflow 2: `release-preview.yml` - Version Preview

**Triggers:** Pull requests to main

**Jobs:**
- Run python-semantic-release in dry-run/preview mode
- Post comment to PR showing:
  - Next version number (e.g., "2.0.1", "2.1.0", "3.0.0")
  - Changelog preview based on commits
  - Which commits triggered the version bump
  - Reminder about conventional commit format if needed

**Purpose:** Give reviewers visibility into release impact before merging.

#### Workflow 3: `release.yml` - Automated Release

**Triggers:** Push to main branch (after PR merge)

**Jobs:**
1. Checkout with full git history
2. Run python-semantic-release to determine version
3. Update version in pyproject.toml
4. Generate changelog entry in docs/changelog.rst
5. Create git tag (e.g., v2.1.0)
6. Build with `uv build` (creates sdist + wheel)
7. Create GitHub Release with auto-generated notes
8. Upload build artifacts to GitHub Release
9. Publish to PyPI using OIDC trusted publisher (no API token)

**Permissions Required:**
```yaml
permissions:
  id-token: write  # For OIDC to PyPI
  contents: write  # For creating releases and tags
```

**Purpose:** Fully automated release pipeline from merge to PyPI publication.

### 4. Version Management & Package Metadata

**Single Source of Truth: `pyproject.toml`**

```toml
[project]
version = "2.0.0"  # python-semantic-release updates this automatically
```

**Dynamic Version Reading:**

**`trigger/__init__.py`:**
```python
from importlib.metadata import version, PackageNotFoundError

try:
    __version__ = version("trigger")
except PackageNotFoundError:
    # Development mode, package not installed
    __version__ = "0.0.0.dev0"
```

**`docs/conf.py`:**
```python
from importlib.metadata import version

release = version("trigger")  # Full version: "2.0.0"
version = ".".join(release.split(".")[:2])  # Short version: "2.0"
```

**Benefits:**
- Version defined once in pyproject.toml
- python-semantic-release updates it automatically
- All code reads from installed package metadata
- No manual version bumps needed
- Works in development mode with fallback

### 5. python-semantic-release Configuration

**Add to `pyproject.toml`:**

```toml
[tool.semantic_release]
version_toml = ["pyproject.toml:project.version"]
branch = "main"
upload_to_pypi = true
upload_to_release = true
build_command = "uv build"
major_on_zero = false
tag_format = "v{version}"

# Commit parsing
commit_parser = "angular"
commit_parser_options = { allowed_tags = ["feat", "fix", "perf", "refactor"], major_tags = ["BREAKING CHANGE"] }

# Changelog generation
changelog_file = "docs/changelog.rst"
changelog_sections = [
    {heading = "Breaking Changes", type = "breaking"},
    {heading = "Features", type = "feat"},
    {heading = "Bug Fixes", type = "fix"},
    {heading = "Performance", type = "perf"},
]

# GitHub release
hvcs = "github"
hvcs_domain = "github.com"
```

**For v2.0.0 Specifically:**
Since this is the initial release with semantic-release, we'll manually create the v2.0.0 tag, then automation takes over for subsequent releases (v2.0.1, v2.1.0, etc.).

### 6. PyPI Trusted Publisher Setup (OIDC)

**Modern Approach:** Use PyPI's trusted publisher feature instead of API tokens.

**Setup Steps (Manual - One Time):**

1. Go to https://pypi.org/manage/account/publishing/
2. Add a new trusted publisher:
   - **PyPI Project Name:** `trigger`
   - **Owner:** `trigger` (GitHub org/user)
   - **Repository name:** `trigger`
   - **Workflow name:** `release.yml`
   - **Environment name:** `release` (optional but recommended)

3. Create `release` environment in GitHub repo settings → Environments

**In release.yml workflow:**
```yaml
- name: Publish to PyPI
  uses: pypa/gh-action-pypi-publish@release/v1
  # No token needed! Uses OIDC
```

**Benefits:**
- No secrets to manage
- Automatic credential rotation
- Better security model
- GitHub verifies workflow identity

### 7. Documentation Strategy

**Files to Update:**

#### `docs/changelog.rst`
Create comprehensive v2.0.0 entry with high-level changes:
- **Breaking Changes:** Python 3.10-3.11 required (Python 2.7 no longer supported)
- **Features:** CLI tools as entry points, pyproject.toml build system
- **Dependencies:** Major updates (Twisted ≥22.10.0, cryptography ≥41.0.0)
- **Testing:** pytest replaces old test runner
- Link to migration guide for detailed upgrade instructions

#### `MIGRATION_GUIDE.md` → `docs/migration.rst`
- Convert existing Markdown migration guide to RST
- Add to docs/ structure and toctree
- Link to published RTD URL (e.g., `trigger.readthedocs.io/en/latest/migration.html`)

#### `docs/conf.py`
- Update to use `importlib.metadata` for version
- Verify Sphinx configuration for version builds

#### `README.md`
- Ensure Python version requirements are accurate (3.10-3.11)
- Update installation instructions
- Add badge/link to versioned docs

**Auto-Generated Going Forward:**
After v2.0.0, python-semantic-release automatically:
- Generates CHANGELOG entries from conventional commits
- Updates version references
- Creates release notes for GitHub

### 8. Read the Docs Configuration

**Create/Update `.readthedocs.yml`:**

```yaml
version: 2

build:
  os: ubuntu-22.04
  tools:
    python: "3.11"
  jobs:
    pre_install:
      - pip install uv
      - uv pip install --system -e ".[dev]"

sphinx:
  configuration: docs/conf.py
  fail_on_warning: false

formats:
  - pdf
  - epub

python:
  install:
    - method: pip
      path: .
      extra_requirements:
        - dev
```

**RTD Dashboard Configuration (Manual):**

1. Log in to https://readthedocs.org/projects/trigger/
2. **Versions tab:**
   - Enable builds for tags matching `v*` pattern
   - Set v2.0.0 as "stable" once released
   - Keep "latest" pointing to main branch
3. **Advanced Settings:**
   - Default version: `stable`
   - Privacy level: Public
4. **Automation rules (recommended):**
   - Auto-activate versions for tags matching `v*`
   - Set stable to highest semantic version

**Documentation Structure:**

Update `docs/index.rst` to include:
```rst
.. toctree::
   :maxdepth: 2

   installation
   migration
   changelog
   ...
```

### 9. Release Verification & Testing Strategy

**Pre-Release Testing Checklist (for v2.0.0):**

**Phase 1: Local Verification**
```bash
# All tests pass
uv run --extra dev pytest -v

# Ruff checks pass
uv run ruff check trigger/ tests/
uv run ruff format --check trigger/ tests/

# Build succeeds
uv build
```

**Phase 2: Clean Environment Testing**

Test installation from built wheel:

```bash
# Python 3.10 test
python3.10 -m venv test-py310
source test-py310/bin/activate
pip install dist/trigger-2.0.0-py3-none-any.whl

# Verify all 14 CLI tools accessible
acl --help && netdev --help && gong --help

# Test basic imports
python -c "from trigger.netdevices import NetDevices; from trigger.acl import parse"
deactivate

# Python 3.11 test (repeat same steps)
```

**Phase 3: Documentation Build**
```bash
cd docs/
make html
# Verify no warnings, check version displayed correctly
```

**Ongoing (Automated in CI):**
- Every PR runs full test suite on Python 3.10 + 3.11
- Every PR runs ruff checks
- Every PR builds package to verify build succeeds
- Every PR shows version preview

### 10. Implementation Steps

**Phase 1: Repository Setup (Manual Steps)**

1. ✅ **Rename `master` → `main`** (GitHub repo settings → Branches → Rename)
2. ✅ **Update default branch to `main`** (GitHub settings)
3. ✅ **Update branch protection rules on `main`**:
   - Require pull request reviews
   - Require status checks to pass (CI workflow)
   - Require branches to be up to date
4. ✅ **Configure PyPI trusted publisher** (follow section 6)
5. ✅ **Configure Read the Docs** (follow section 8)

**Phase 2: Code & Configuration Updates**

6. Add `importlib.metadata` version reading to `trigger/__init__.py`
7. Update `docs/conf.py` to use `importlib.metadata`
8. Convert `MIGRATION_GUIDE.md` → `docs/migration.rst`
9. Add to `docs/index.rst` toctree
10. Add python-semantic-release config to `pyproject.toml`
11. Add `ruff` to dev dependencies in `pyproject.toml`
12. Configure ruff in `pyproject.toml`:
    ```toml
    [tool.ruff]
    line-length = 88
    target-version = "py310"
    exclude = ["trigger/packages"]
    ```
13. Update `docs/changelog.rst` with comprehensive v2.0.0 entry
14. Update `README.md` with current version info and links

**Phase 3: GitHub Actions Workflows**

15. Create `.github/workflows/ci.yml` (tests + ruff)
16. Create `.github/workflows/release-preview.yml` (version preview on PRs)
17. Create `.github/workflows/release.yml` (automated release on merge to main)

**Phase 4: Testing & Verification**

18. Merge `develop` into `release/v2.0.0` branch
19. Run full test suite: `uv run --extra dev pytest -v`
20. Run ruff checks: `uv run ruff check trigger/ tests/`
21. Test builds: `uv build`
22. Test clean installs in Python 3.10 and 3.11 environments
23. Verify all 14 CLI tools are accessible
24. Build and review docs locally: `cd docs && make html`

**Phase 5: v2.0.0 Release**

25. Create PR from `release/v2.0.0` → `main`
26. Verify CI passes
27. Merge PR
28. Manually create v2.0.0 tag:
    ```bash
    git checkout main
    git pull
    git tag -a v2.0.0 -m "Release v2.0.0: Python 3.10-3.11 support"
    git push origin v2.0.0
    ```
29. Verify release workflow runs successfully
30. Verify release on PyPI: https://pypi.org/project/trigger/2.0.0/
31. Verify GitHub Release created
32. Test install: `pip install trigger==2.0.0`
33. Verify RTD built v2.0.0 docs and set as stable

**Phase 6: Cleanup & Post-Release**

34. Add deprecation notice to `develop` branch
35. Archive or delete `develop` branch
36. Delete `release/v2.0.0` branch
37. Update README.md badge to show latest version
38. Announce release (Gitter, IRC, social media)

## Success Criteria

1. ✅ v2.0.0 published to PyPI with Python 3.10-3.11 support
2. ✅ All tests passing on Python 3.10 and 3.11
3. ✅ All 14 CLI tools accessible via entry points
4. ✅ Comprehensive migration guide published on RTD
5. ✅ Automated release workflow functional (test with v2.0.1 patch)
6. ✅ Documentation versioned on RTD with v2.0.0 as stable
7. ✅ Clean install works in isolated Python 3.10/3.11 environments
8. ✅ Conventional commits enforced via CI checks

## Future Enhancements (Post-v2.0.0)

- Python 3.12+ support when SimpleParse compatibility resolved
- Conventional commit linting in CI (commitlint or similar)
- Release notes templates for consistent formatting
- Automated announcement posting (optional)

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| PyPI trusted publisher setup fails | Cannot publish to PyPI | Fallback to manual token-based publishing for v2.0.0 only |
| RTD build fails on v2.0.0 | Docs unavailable | Test docs build locally first, fix before tagging |
| Users miss Python 2.7 deprecation message | Support burden | Prominent messaging in README, migration guide, PyPI description |
| Semantic release misinterprets commits | Wrong version bump | Use release-preview.yml to catch before merge |
| CLI tools not accessible after install | User frustration | Test in clean environment before release |

## Open Questions

None - design approved.

## References

- python-semantic-release: https://python-semantic-release.readthedocs.io/
- Conventional Commits: https://www.conventionalcommits.org/
- PyPI Trusted Publishers: https://docs.pypi.org/trusted-publishers/
- GitHub Actions OIDC: https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect
- Ruff: https://docs.astral.sh/ruff/
